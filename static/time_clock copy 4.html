<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
      Kiosk — Time Clock (PIN only, colored buttons, protected actions)
    </title>
    <style>
      :root {
        --bg: #fff;
        --text: #111;
        --muted: #6b7280;
        --line: #e5e7eb;
        --shadow: 0 2px 10px rgba(0, 0, 0, 0.07);
        --in: #10b981;
        --out: #ef4444;
        --sbr: #f59e0b;
        --ebr: #6366f1;
        --disabled: #e5e7eb;

        /* Action button sizing (tweak these) */
        --btn-min: 220px; /* minimum height */
        --btn-vh: 24vh; /* responsive chunk of viewport height */
        --btn-max: 360px; /* maximum height */
        --btn-radius: 12px;

        --btn-fs-min: 42px; /* minimum font size */
        --btn-fs-vw: 4.8vw; /* responsive scaling */
        --btn-fs-max: 84px;
      }

      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font: 20px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      }
      .wrap {
        max-width: 980px;
        margin: 24px auto;
        padding: 0 14px;
      }
      h1 {
        margin: 0 0 16px;
        font-size: 28px;
      }
      .muted {
        color: var(--muted);
      }

      /* View toggling */
      .view {
        display: none;
      }
      .view.active {
        display: block;
      }

      /* Panels & rows */
      .panel {
        background: #fff;
        border: 2px solid var(--line);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 16px;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      /* Top display strip */
      .display {
        font-size: 28px;
        font-weight: 700;
        border: 2px solid var(--line);
        border-radius: 12px;
        padding: 12px 14px;
        min-height: 56px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
      }
      .display span.value {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", monospace;
      }

      /* Keypad */
      .keypad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 16px;
      }
      .key {
        font-size: 32px;
        font-weight: 700;
        border: 2px solid var(--line);
        border-radius: 10px;
        padding: 22px 0;
        background: #fff;
        cursor: pointer;
      }
      .key:active {
        transform: scale(0.98);
      }

      /* Status chip */
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: 2px solid var(--line);
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 16px;
      }
      .dot {
        width: 14px;
        height: 14px;
        border-radius: 999px;
        display: inline-block;
      }
      .dot.off {
        background: #9ca3af;
      }
      .dot.in {
        background: #16a34a;
      }
      .dot.break {
        background: #d97706;
      }

      /* Button layout */
      .grid-actions {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }

      /* BIG ACTION BUTTONS */
      .bigbtn {
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid transparent;
        border-radius: var(--btn-radius);
        min-height: clamp(var(--btn-min), var(--btn-vh), var(--btn-max));
        padding: 36px 28px;
        font-weight: 800;
        color: #fff;
        box-shadow: var(--shadow);
        cursor: pointer;
        font-size: clamp(
          var(--btn-fs-min),
          var(--btn-fs-vw),
          var(--btn-fs-max)
        );
        line-height: 1.1;
        white-space: normal;
        text-wrap: balance;
      }
      .bigbtn {
        gap: 14px;
      }
      .bigbtn .ico {
        width: 1.6em;
        height: 1.6em;
        flex: 0 0 auto;
        stroke-width: 2.2;
      }
      .bigbtn:hover:not([disabled]) {
        filter: saturate(1.08) brightness(0.98);
      }
      .bigbtn:active:not([disabled]) {
        transform: scale(0.98);
        filter: brightness(0.92);
      }
      .bigbtn:focus-visible {
        outline: 3px solid rgba(0, 0, 0, 0.2);
        outline-offset: 2px;
      }
      .bigbtn[disabled] {
        background: var(--disabled);
        color: #9ca3af;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      /* Action colors */
      .btn-in {
        background: var(--in);
      }
      .btn-sbr {
        background: var(--sbr);
      }
      .btn-ebr {
        background: var(--ebr);
      }
      .btn-out {
        background: var(--out);
      }

      /* Table & badges */
      table {
        border-collapse: collapse;
        width: 100%;
        font-size: 18px;
      }
      th,
      td {
        padding: 10px;
        border-bottom: 1px solid var(--line);
        text-align: left;
      }
      th {
        background: #f9fafb;
      }
      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 14px;
        color: #fff;
      }
      .b-in {
        background: var(--in);
      }
      .b-out {
        background: var(--out);
      }
      .b-sbr {
        background: var(--sbr);
      }
      .b-ebr {
        background: var(--ebr);
      }

      /* Passcode dots */
      .passdots {
        display: flex;
        gap: 14px;
        align-items: center;
        justify-content: center;
        width: 100%;
      }
      .passdot {
        width: 16px;
        height: 16px;
        border-radius: 999px;
        border: 2px solid var(--line);
      }
      .passdot.filled {
        background: #111;
        border-color: #111;
      }

      /* Topbar */
      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 14px;
        margin: 0 0 12px;
        border: 2px solid var(--line);
        border-radius: 12px;
        background: #fff;
        box-shadow: var(--shadow);
        font-weight: 700;
        font-size: 22px;
      }
      #top_title {
        font-weight: 700;
        font-size: 22px;
      }
      #id_val {
        flex: 1;
        display: flex;
        justify-content: center;
        letter-spacing: 3px;
      }
      #clock {
        font-size: 20px;
        font-weight: 600;
        white-space: nowrap;
      }

      /* Row for Start Break + Clock Out side-by-side */
      .row-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .row-2:has(.bigbtn[style*="display: none"])
        .bigbtn:not([style*="display: none"]) {
        grid-column: 1 / -1;
      }

      /* Mobile */
      @media (max-width: 540px) {
        .row-2 {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- View 1: 4-digit User ID -->
    <section id="v_id" class="view active">
      <div class="panel">
        <div class="display" style="margin-top: 12px">
          <span id="top_title">TopNotch v1.0</span>
          <span
            id="id_val"
            class="passdots"
            aria-label="Enter 4-digit code"
            aria-live="polite"
          ></span>
          <span id="clock" aria-live="polite"></span>
        </div>
        <div class="keypad" id="id_pad" style="margin-top: 16px"></div>
      </div>
    </section>

    <!-- View 2: Actions -->
    <section id="v_act" class="view">
      <div class="panel">
        <div
          class="row"
          style="justify-content: space-between; gap: 16px; flex-wrap: wrap"
        >
          <div>
            <div style="font-size: 22px; font-weight: 800">
              Welcome, <span id="emp_name"></span>
            </div>
          </div>
          <div class="chip" id="chip">
            <span class="dot off"></span>
            <span id="chip_status">Off Duty</span>
            <span
              id="chip_time"
              style="margin-left: 8px; font-weight: 600; font-size: 16px"
            ></span>
          </div>
        </div>

        <div class="grid-actions" style="margin-top: 16px">
          <button class="bigbtn btn-in" id="btn_in">
            <svg
              class="ico"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              aria-hidden="true"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M5 4v16"></path>
              <path d="M10 12h10"></path>
              <path d="M16 8l4 4-4 4"></path></svg
            ><span>Clock In</span>
          </button>

          <div class="row-2">
            <button class="bigbtn btn-sbr" id="btn_sbr">
              <svg
                class="ico"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                aria-hidden="true"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="10" width="12" height="6" rx="2"></rect>
                <path d="M15 11h3a2 2 0 0 1 0 4h-3"></path>
                <path d="M7 7v2M9 6v2M11 7v2"></path></svg
              ><span>Start Break</span>
            </button>

            <button class="bigbtn btn-out" id="btn_out">
              <svg
                class="ico"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                aria-hidden="true"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M19 4v16"></path>
                <path d="M14 12H4"></path>
                <path d="M8 8l-4 4 4 4"></path></svg
              ><span>Clock Out</span>
            </button>
          </div>

          <button class="bigbtn btn-ebr" id="btn_ebr">
            <svg
              class="ico"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              aria-hidden="true"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="3" y="8" width="18" height="12" rx="2"></rect>
              <path d="M9 8V6h6v2"></path>
              <path d="M3 13h18"></path></svg
            ><span>Stop Break</span>
          </button>
        </div>

        <div
          class="row"
          style="justify-content: space-between; margin-top: 16px"
        >
          <button class="key action" id="btn_logout" style="padding: 12px 16px">
            Logout
          </button>
        </div>
      </div>

      <div class="panel" style="margin-top: 16px">
        <div style="font-size: 22px; font-weight: 700; margin-bottom: 8px">
          Last 4 Activities Today
        </div>
        <table>
          <thead>
            <tr>
              <th style="width: 220px">Time</th>
              <th style="width: 160px">Action</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="log"></tbody>
        </table>
      </div>
    </section>

    <script type="module">
      import { $, jfetch, toast } from "/static/js/api.js?v=1";

      /* ----------------- API base ----------------- */
      const API_BASE = ""; // same origin as your kiosk.html
      const api = (p) => `${API_BASE}${p}`;

      /* ----------------- Offline keys & helpers ----------------- */
      const QUEUE_KEY = "kiosk_queue_v1";
      const EMP_CACHE_KEY = "kiosk_emp_cache_v1";
      const EVENTS_PREFIX = "kiosk_events_v1_";
      const EMP_TTL_MS = 7 * 24 * 60 * 60 * 1000; // 7 days

      const pad = (n) => String(n).padStart(2, "0");
      const fmtTime = (ts) => {
        if (!ts) return "";
        const d = new Date(ts);
        return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(
          d.getSeconds()
        )}`;
      };
      const startOfTodayISO = () => {
        const d = new Date();
        d.setHours(0, 0, 0, 0);
        return d.toISOString();
      };
      const startOfTomorrowISO = () => {
        const d = new Date();
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 1);
        return d.toISOString();
      };
      const setView = (id) => {
        ["v_id", "v_act"].forEach((v) => $(v).classList.remove("active"));
        $(id).classList.add("active");
      };
      const uuid = () =>
        `loc-${Date.now().toString(36)}-${Math.random()
          .toString(36)
          .slice(2, 8)}`;

      function todayKey(code) {
        const d = new Date();
        const y = d.getFullYear();
        const m = pad(d.getMonth() + 1);
        const dd = pad(d.getDate());
        return `${EVENTS_PREFIX}${y}-${m}-${dd}::${code || "unknown"}`;
      }

      /* local events (for table) */
      function pushLocalEvent(code, ev) {
        if (!code) return;
        const key = todayKey(code);
        const arr = JSON.parse(localStorage.getItem(key) || "[]");
        arr.push(ev);
        localStorage.setItem(key, JSON.stringify(arr));
      }
      function getLocalEvents(code) {
        if (!code) return [];
        const key = todayKey(code);
        try {
          return JSON.parse(localStorage.getItem(key) || "[]");
        } catch {
          return [];
        }
      }

      /* employee cache */
      function loadEmpCache() {
        try {
          return JSON.parse(localStorage.getItem(EMP_CACHE_KEY) || "{}");
        } catch {
          return {};
        }
      }
      function saveEmpCache(c) {
        localStorage.setItem(EMP_CACHE_KEY, JSON.stringify(c));
      }
      function rememberEmployee(code, info) {
        if (!code) return;
        const c = loadEmpCache();
        c[code] = { ...(c[code] || {}), ...info, updated_at: Date.now() };
        saveEmpCache(c);
      }
      function recallEmployee(code) {
        const rec = loadEmpCache()[code];
        if (!rec) return null;
        if (EMP_TTL_MS && Date.now() - (rec.updated_at || 0) > EMP_TTL_MS)
          return null;
        return rec;
      }

      /* queue for offline POSTs */
      function loadQueue() {
        try {
          return JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]");
        } catch {
          return [];
        }
      }
      function saveQueue(q) {
        localStorage.setItem(QUEUE_KEY, JSON.stringify(q));
      }

      async function safePost(endpoint, body) {
        const attempt = async () =>
          jfetch(api(endpoint), { method: "POST", body: JSON.stringify(body) });
        if (navigator.onLine) {
          try {
            const res = await attempt();
            return { ok: true, queued: false, res };
          } catch (e) {
            /* fall back to queue */
          }
        }
        const q = loadQueue();
        q.push({
          id: uuid(),
          endpoint,
          method: "POST",
          body,
          created_at: Date.now(),
          tries: 0,
        });
        saveQueue(q);
        return { ok: false, queued: true };
      }

      async function processQueue() {
        const q = loadQueue();
        if (q.length === 0 || !navigator.onLine) return;
        let changed = false;
        for (let i = 0; i < q.length; i++) {
          const item = q[i];
          try {
            await jfetch(api(item.endpoint), {
              method: item.method,
              body: JSON.stringify(item.body),
            });
            q.splice(i, 1);
            i--;
            changed = true;
          } catch (e) {
            item.tries = (item.tries || 0) + 1;
          }
        }
        if (changed) saveQueue(q);
        if ($("v_act").classList.contains("active") && state.code) {
          try {
            await fetchStateByCode(state.code);
          } catch {}
        }
      }
      setInterval(processQueue, 15000);
      window.addEventListener("online", processQueue);

      /* ----------------- UI helpers ----------------- */
      function hide(el) {
        if (!el) return;
        if (document.activeElement === el) el.blur();
        el.style.display = "none";
      }
      function show(el) {
        if (!el) return;
        el.style.display = "";
      }

      function setChip(status) {
        const dot = document.querySelector("#chip .dot");
        const txt = document.getElementById("chip_status");
        const timeEl = document.getElementById("chip_time");
        dot.className = "dot " + (status || "off");
        txt.textContent =
          status === "in"
            ? "Clocked In"
            : status === "break"
            ? "On Break"
            : "Off Duty";
        const now = new Date();
        timeEl.textContent = now.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: true,
        });
      }

      /* ----------------- state ----------------- */
      const state = {
        code: "",
        idDigits: "",
        empName: "",
        employeeId: null,
        timeEntryId: null,
        breakId: null,
        status: "off",
        busy: false,
        hasBreakUsed: false,
        shadow: { openTimeEntryId: null, openBreakId: null }, // ใช้ตอนออฟไลน์
      };

      /* ----------------- UI logic (hide/show buttons) ----------------- */
      function updateButtons() {
        const inBtn = $("btn_in");
        const outBtn = $("btn_out");
        const sbrBtn = $("btn_sbr");
        const ebrBtn = $("btn_ebr");
        [inBtn, outBtn, sbrBtn, ebrBtn].forEach(hide);

        const st = state.status; // 'off' | 'in' | 'break'
        const onBreak = !!(state.breakId || state.shadow.openBreakId);
        const usedBreakThisShift = !!state.hasBreakUsed;

        if (st === "off") {
          show(inBtn);
          return;
        }
        if (st === "break" || onBreak) {
          show(ebrBtn);
          return;
        }
        if (usedBreakThisShift) {
          show(outBtn);
        } else {
          show(sbrBtn);
          show(outBtn);
        }
      }

      function logout() {
        setView("v_id");
        clearId();
        const title = document.getElementById("top_title");
        if (title) title.textContent = "TopNotch v1.0";
        toast("Logged out");
        state.code = "";
        state.empName = "";
        state.employeeId = null;
        state.timeEntryId = null;
        state.breakId = null;
        state.status = "off";
        state.hasBreakUsed = false;
        state.shadow.openTimeEntryId = null;
        state.shadow.openBreakId = null;
        setChip("off");
        updateButtons();
        renderLog([]);
      }

      /* ----------------- log renderer ----------------- */
      function renderLog(rows) {
        const tb = $("log");
        if (!rows || rows.length === 0) {
          tb.innerHTML = `<tr><td colspan="3"><span class="muted">No entries yet today</span></td></tr>`;
          return;
        }
        tb.innerHTML = rows
          .map((r) => {
            const badgeCls =
              r.kind === "in"
                ? "b-in"
                : r.kind === "out"
                ? "b-out"
                : r.kind === "sbr"
                ? "b-sbr"
                : "b-ebr";
            const label =
              r.kind === "in"
                ? "Clock In"
                : r.kind === "out"
                ? "Clock Out"
                : r.kind === "sbr"
                ? "Start Break"
                : "Stop Break";
            return `<tr>
                  <td>${fmtDateTime(r.ts)}</td>
                  <td><span class="badge ${badgeCls}">${label}</span></td>
                  <td>${r.note || ""}</td>
                </tr>`;
          })
          .join("");
      }

      async function fetchTodayLog() {
        if (!state.employeeId) {
          // ออฟไลน์/ไม่รู้ employee_id → ใช้ events local
          const events = getLocalEvents(state.code).sort(
            (a, b) => new Date(b.ts) - new Date(a.ts)
          );
          renderLog(events.slice(0, 4));
          updateButtons();
          return;
        }

        const qs = new URLSearchParams({
          employee_id: String(state.employeeId),
          start_at: startOfTodayISO(),
          end_at: startOfTomorrowISO(),
        }).toString();

        try {
          let rows;
          try {
            rows = await jfetch(api(`/time-entries/range?${qs}`));
          } catch {
            rows = await jfetch(api(`/time-entries?${qs}`));
          }

          let currentTE = null;
          if (state.timeEntryId != null) {
            currentTE = rows.find((te) => te.id === state.timeEntryId) || null;
          }

          if (currentTE && Array.isArray(currentTE.breaks)) {
            state.hasBreakUsed = currentTE.breaks.some(
              (b) => b.start_at != null
            );
          } else {
            // ถ้าไม่มีจากเซิร์ฟเวอร์ ให้ดูจาก local events เผื่อกรณีออฟไลน์ก่อนหน้า
            state.hasBreakUsed = getLocalEvents(state.code).some(
              (e) => e.kind === "sbr"
            );
          }

          const events = [];
          for (const te of rows) {
            if (te.clock_in_at) events.push({ kind: "in", ts: te.clock_in_at });
            if (Array.isArray(te.breaks)) {
              for (const br of te.breaks) {
                if (br.start_at) events.push({ kind: "sbr", ts: br.start_at });
                if (br.end_at) events.push({ kind: "ebr", ts: br.end_at });
              }
            }
            if (te.clock_out_at)
              events.push({ kind: "out", ts: te.clock_out_at });
          }

          // ผสมกับ events local
          events.push(...getLocalEvents(state.code));
          events.sort((a, b) => new Date(b.ts) - new Date(a.ts));
          renderLog(events.slice(0, 4));

          updateButtons();
        } catch (e) {
          const events = getLocalEvents(state.code).sort(
            (a, b) => new Date(b.ts) - new Date(a.ts)
          );
          renderLog(events.slice(0, 4));
          updateButtons();
          // ออฟไลน์ก็ไม่ต้อง toast ซ้ำ ๆ ให้รก
          if (navigator.onLine) toast(e.message || "Load log failed", false);
        }
      }

      /* ----------------- server state ----------------- */
      async function fetchStateByCode(code) {
        try {
          const data = await jfetch(
            api(`/time-entries/state/${encodeURIComponent(code)}`)
          );
          state.status = data.status || "off";
          state.timeEntryId = data.time_entry_id || null;
          state.breakId = data.break_id || null;
          state.employeeId = data.employee_id || null;
          state.empName = data.name || state.empName || "Employee";
          // จำพนักงานไว้สำหรับล็อกอินออฟไลน์ครั้งต่อไป
          rememberEmployee(code, {
            name: state.empName,
            employee_id: state.employeeId,
          });
        } catch (e) {
          // ล็อกอินออฟไลน์ด้วยแคช
          const cached = recallEmployee(code);
          if (!cached) throw e;
          state.empName = cached.name || "Employee";
          state.employeeId = cached.employee_id || null;
          // เดาสถานะจาก shadow (ปุ่มจะถูกต้อง)
          if (state.shadow.openBreakId) state.status = "break";
          else if (state.shadow.openTimeEntryId) state.status = "in";
          else state.status = "off";
        }

        $("emp_name").textContent = state.empName;
        const title = document.getElementById("top_title");
        if (title) title.textContent = `TopNotch v1.0 — ${state.empName}`;

        setChip(state.status);
        updateButtons();
        await fetchTodayLog();
      }

      /* ----------------- actions (queue when offline) ----------------- */
      async function clockIn() {
        if (state.busy) return;
        state.busy = true;
        try {
          const resp = await safePost("/time-entries/start", {
            code: state.code,
            method: "web",
          });
          // อัปเดตสถานะทันที (optimistic)
          state.status = "in";
          state.shadow.openTimeEntryId = state.shadow.openTimeEntryId || uuid();
          pushLocalEvent(state.code, {
            kind: "in",
            ts: new Date().toISOString(),
          });

          setChip("in");
          updateButtons();
          await fetchTodayLog();
          toast(resp.queued ? "Clocked in (queued)" : "Clocked in");
          logout();
        } catch (e) {
          toast(e.message || "Clock in failed", false);
        } finally {
          state.busy = false;
        }
      }

      async function clockOut() {
        if (state.busy) return;
        state.busy = true;
        try {
          const resp = await safePost("/time-entries/stop", {
            code: state.code,
            method: "web",
          });
          pushLocalEvent(state.code, {
            kind: "out",
            ts: new Date().toISOString(),
          });

          state.status = "off";
          state.timeEntryId = null;
          state.breakId = null;
          state.hasBreakUsed = false;
          state.shadow.openTimeEntryId = null;
          state.shadow.openBreakId = null;

          setChip("off");
          updateButtons();
          await fetchTodayLog();
          toast(resp.queued ? "Clocked out (queued)" : "Clocked out");
          logout();
        } catch (e) {
          toast(e.message || "Clock out failed", false);
        } finally {
          state.busy = false;
        }
      }

      async function startBreak() {
        if (state.busy) return;
        state.busy = true;
        try {
          const resp = await safePost("/breaks/start", {
            code: state.code,
            break_type: "lunch",
            is_paid: false,
            method: "web",
          });
          state.status = "break";
          state.shadow.openBreakId = state.shadow.openBreakId || uuid();
          pushLocalEvent(state.code, {
            kind: "sbr",
            ts: new Date().toISOString(),
          });

          setChip("break");
          updateButtons();
          await fetchTodayLog();
          toast(resp.queued ? "Break started (queued)" : "Break started");
          logout();
        } catch (e) {
          toast(e.message || "Start break failed", false);
        } finally {
          state.busy = false;
        }
      }

      async function stopBreak() {
        if (state.busy) return;
        state.busy = true;
        try {
          const resp = await safePost("/breaks/stop", { code: state.code });
          pushLocalEvent(state.code, {
            kind: "ebr",
            ts: new Date().toISOString(),
          });

          state.status = "in";
          state.shadow.openBreakId = null;
          state.hasBreakUsed = true;

          setChip("in");
          updateButtons();
          await fetchTodayLog();
          toast(resp.queued ? "Break stopped (queued)" : "Break stopped");
          logout();
        } catch (e) {
          toast(e.message || "Stop break failed", false);
        } finally {
          state.busy = false;
        }
      }

      /* ----------------- keypad ----------------- */
      function renderPad(el) {
        const keys = [
          "1",
          "2",
          "3",
          "4",
          "5",
          "6",
          "7",
          "8",
          "9",
          "⌫",
          "0",
          "Clear",
        ];
        el.innerHTML = keys
          .map(
            (k) =>
              `<button class="key${
                isNaN(+k) ? " action" : ""
              }" data-k="${k}">${k}</button>`
          )
          .join("");
        el.addEventListener("click", async (e) => {
          const b = e.target.closest("button[data-k]");
          if (!b) return;
          const k = b.dataset.k;
          if (!isNaN(+k)) state.idDigits = (state.idDigits + k).slice(0, 4);
          else if (k === "⌫") state.idDigits = state.idDigits.slice(0, -1);
          else state.idDigits = "";
          renderIdDots();
          if (state.idDigits.length === 4) {
            await handleFourDigits(state.idDigits);
          }
        });
      }

      async function handleFourDigits(code) {
        // ถ้าออฟไลน์และมีแคช → เข้าได้เลย
        if (!navigator.onLine) {
          const cached = recallEmployee(code);
          if (cached) {
            state.empName = cached.name || "Employee";
            state.employeeId = cached.employee_id || null;
            if (state.shadow.openBreakId) state.status = "break";
            else if (state.shadow.openTimeEntryId) state.status = "in";
            else state.status = "off";

            $("emp_name").textContent = state.empName;
            const title = document.getElementById("top_title");
            if (title) title.textContent = `TopNotch v1.0 — ${state.empName}`;

            setChip(state.status);
            state.code = code;
            setView("v_act");
            await fetchTodayLog();
            toast("Offline login (cached)");
            return;
          }
        }
        // ปกติ: ออนไลน์ หรือไม่มีแคช
        try {
          await fetchStateByCode(code); // validate + pull name/status
          state.code = code;
          setView("v_act");
        } catch (e) {
          toast(e.message || "Invalid code", false);
          clearId();
        }
      }

      function clearId() {
        state.idDigits = "";
        renderIdDots();
      }

      /* ----------------- boot ----------------- */
      document.addEventListener("DOMContentLoaded", () => {
        renderPad($("id_pad"));
        renderIdDots();
        startClock();
        $("btn_in").addEventListener("click", clockIn);
        $("btn_out").addEventListener("click", clockOut);
        $("btn_sbr").addEventListener("click", startBreak);
        $("btn_ebr").addEventListener("click", stopBreak);
        $("btn_logout").addEventListener("click", () => {
          logout();
        });
        updateButtons();
        startChipClock();
        processQueue(); // เผื่อมีคิวค้างจากก่อนหน้า
      });

      function renderIdDots() {
        const n = state.idDigits.length;
        const dots = Array.from(
          { length: 4 },
          (_, i) => `<span class="passdot${i < n ? " filled" : ""}"></span>`
        ).join("");
        $("id_val").innerHTML = dots;
      }

      function startClock() {
        const el = document.getElementById("clock");
        const tick = () => {
          const now = new Date();
          let hh = now.getHours();
          const ampm = hh >= 12 ? "PM" : "AM";
          hh = hh % 12 || 12; // convert 0 → 12
          const mm = String(now.getMinutes()).padStart(2, "0");
          const ss = String(now.getSeconds()).padStart(2, "0");
          el.textContent = `${hh}:${mm}:${ss} ${ampm}`;
        };
        tick();
        return setInterval(tick, 1000);
      }

      function fmtDateTime(ts) {
        if (!ts) return "";
        const d = new Date(ts);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mi = String(d.getMinutes()).padStart(2, "0");
        const ss = String(d.getSeconds()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
      }

      function startChipClock() {
        const timeEl = document.getElementById("chip_time");
        if (!timeEl) return;
        setInterval(() => {
          const now = new Date();
          timeEl.textContent = now.toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: true,
          });
        }, 1000);
      }
    </script>
  </body>
</html>
