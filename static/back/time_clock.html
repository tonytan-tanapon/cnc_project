<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Time Clock</title>
  <style>
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fff;color:#111;margin:24px}
    #now{font-size:28px;font-weight:700;margin-bottom:8px}
    .sub{display:flex;gap:12px;align-items:center;flex-wrap:wrap;color:#666;font-size:13px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
    button{font:inherit;padding:20px;border:none;border-radius:10px;color:#fff;font-weight:700;cursor:pointer;transition:background .2s}
    button:disabled{opacity:.6;cursor:not-allowed}
    /* Colors */
    #btnLeft.clock-in{background:#2d9cdb}       /* blue: Clock In */
    #btnLeft.clock-out{background:#eb5757}      /* red : Clock Out */
    #btnRight.start-break{background:#f2c94c;color:#111} /* yellow: Start Break */
    #btnRight.stop-break{background:#27ae60}    /* green : Stop Break */

    .list{border:1px solid #e5e5e5;border-radius:10px}
    .item{display:grid;grid-template-columns:200px 1fr;gap:12px;padding:10px 12px;border-top:1px solid #f0f0f0}
    .item:first-child{border-top:0}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace}
    .muted{color:#666}
    .head{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
    small{font-size:12px}
    .badge{display:inline-block;border:1px solid #e5e5e5;padding:4px 8px;border-radius:999px;font-size:12px;color:#444;background:#fafafa}
    .tiny{font-size:12px;color:#888}

    /* Logout button (small/ghost) */
    .ghost{padding:8px 12px;border:1px solid #ddd;border-radius:999px;background:#fff;color:#333;font-weight:600}
    .ghost:hover{background:#f7f7f7}
  </style>
</head>
<body>
  <div id="now">—</div>

  <div class="sub">
    <span id="who" class="badge">กำลังตรวจสอบผู้ใช้…</span>
    <span class="tiny">API: <span id="apiInfo">—</span></span>
    <button id="btnLogout" class="ghost" type="button" title="ออกจากระบบ (ล้างโทเค็น)">Logout</button>
  </div>

  <div class="row">
    <button id="btnLeft"  class="clock-in">Clock In</button>
    <button id="btnRight" class="start-break" disabled>Start Break</button>
  </div>

  <div class="head">
    <strong>Activity</strong>
    <small class="muted">(Clock In, Clock Out, Start Break, Stop Break)</small>
  </div>
  <div id="activity" class="list"></div>

  <script>
    // ======= Config / Auth =======
    const API_BASE = (localStorage.getItem('api_base') || '').trim() || location.origin;
    const TOKEN = localStorage.getItem('access_token');
    if (!TOKEN) {
      alert('โปรดเข้าสู่ระบบก่อน');
      window.location.href = '/static/login.html';
    }
    document.getElementById('apiInfo').textContent = API_BASE;

    // ======= State (kept locally; server is source of truth) =======
    const LS_KEY = 'time_clock_state_v2';
    const state = { status:'idle', activities:[], timeEntryId:null, lastBreakId:null };
    (function load(){
      try {
        const s = JSON.parse(localStorage.getItem(LS_KEY));
        if (s) Object.assign(state, s);
      } catch {}
    })();
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    const $ = id => document.getElementById(id);
    const left = $('btnLeft'), right = $('btnRight'), btnLogout = $('btnLogout');

    const fmt = ts => new Date(ts).toLocaleString();
    const nowISO = () => new Date().toISOString();

    // ======= API helper =======
    async function apiFetch(path, options={}){
      const res = await fetch(API_BASE + path, {
        ...options,
        headers: {
          'Content-Type':'application/json',
          'Authorization': `Bearer ${TOKEN}`,
          ...(options.headers || {})
        }
      });
      if (res.status === 401){
        alert('Session หมดอายุ กรุณาเข้าสู่ระบบใหม่');
        localStorage.removeItem('access_token');
        window.location.href = '/static/login.html';
        return;
      }
      if (!res.ok){
        const t = await res.text();
        throw new Error(`${res.status}: ${t}`);
      }
      const ct = res.headers.get('content-type') || '';
      return ct.includes('application/json') ? res.json() : res.text();
    }

    async function fetchMe(){
      try{
        const me = await apiFetch('/auth/me');
        $('who').textContent = `User: ${me.username} (id=${me.id})`;
      }catch(e){
        $('who').textContent = 'ไม่สามารถดึงข้อมูลผู้ใช้';
      }
    }

    // ======= UI Render =======
    function addActivity(kind){
      state.activities.unshift({ kind, at: nowISO() });
      renderActivities();
      save();
    }

    function renderActivities(){
      const box = $('activity');
      if (!state.activities.length){
        box.innerHTML = '<div class="item muted">No activity yet.</div>';
        return;
      }
      box.innerHTML = state.activities.map(a => `
        <div class="item">
          <div class="mono">${fmt(a.at)}</div>
          <div>${a.kind}</div>
        </div>
      `).join('');
    }

    function updateButtons(){
      if (state.status === 'idle'){
        left.textContent = 'Clock In';
        left.className = 'clock-in';
      } else {
        left.textContent = 'Clock Out';
        left.className = 'clock-out';
      }
      right.disabled = (state.status === 'idle');
      if (state.status === 'working'){
        right.textContent = 'Start Break';
        right.className = 'start-break';
      }
      if (state.status === 'lunch'){
        right.textContent = 'Stop Break';
        right.className = 'stop-break';
      }
    }

    function tickNow(){ $('now').textContent = new Date().toLocaleString(); }

    // ======= Actions (call API) =======
    async function onLeft(){
      try{
        if (state.status === 'idle'){
          // Start time entry (Clock In) — employee_id is resolved on backend from current user
          const tr = await apiFetch('/time-entries/start', { method:'POST', body: JSON.stringify({}) });
          state.timeEntryId = tr.id;
          state.status = 'working';
          addActivity('Clock In');
        } else {
          // Stop time entry (Clock Out). Backend will auto-stop an active break if any.
          if (!state.timeEntryId){ throw new Error('ไม่พบ timeEntryId ในสถานะปัจจุบัน'); }
          await apiFetch(`/time-entries/${state.timeEntryId}/stop`, { method:'POST', body: JSON.stringify({}) });
          state.status = 'idle';
          state.lastBreakId = null;
          state.timeEntryId = null;
          addActivity('Clock Out');
        }
        updateButtons(); save();
      }catch(e){
        console.error(e); alert('ทำรายการไม่สำเร็จ: ' + e.message);
      }
    }

    async function onRight(){
      try{
        if (state.status === 'working'){
          if (!state.timeEntryId){ throw new Error('ไม่พบ timeEntryId ในสถานะปัจจุบัน'); }
          const br = await apiFetch('/breaks/start', {
            method:'POST',
            body: JSON.stringify({
              time_entry_id: state.timeEntryId,
              break_type: 'lunch',
              is_paid: false,
              method: 'web',
              location: null,
              notes: null
            })
          });
          state.lastBreakId = br.id;
          state.status = 'lunch';
          addActivity('Start Break');
        } else if (state.status === 'lunch'){
          if (!state.lastBreakId){ throw new Error('ไม่พบ breakId ในสถานะปัจจุบัน'); }
          await apiFetch(`/breaks/${state.lastBreakId}/stop`, { method:'POST', body: JSON.stringify({}) });
          state.status = 'working';
          state.lastBreakId = null;
          addActivity('Stop Break');
        }
        updateButtons(); save();
      }catch(e){
        console.error(e); alert('ทำรายการไม่สำเร็จ: ' + e.message);
      }
    }

    function doLogout(){
      if (!confirm('ออกจากระบบใช่ไหม?')) return;
      localStorage.removeItem('access_token');
      localStorage.removeItem('token_type');
      localStorage.removeItem('current_user');
      // อาจล้าง state ด้วย หากต้องการเริ่มใหม่ทุกครั้ง
      // localStorage.removeItem('time_clock_state_v2');
      window.location.href = '/static/login.html';
    }

    function bind(){
      left.addEventListener('click', onLeft);
      right.addEventListener('click', onRight);
      btnLogout.addEventListener('click', doLogout);
    }

    // ======= Init =======
    bind();
    updateButtons();
    renderActivities();
    tickNow(); setInterval(tickNow, 1000);
    fetchMe();
  </script>
</body>
</html>
