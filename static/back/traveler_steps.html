<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Traveler Steps</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px}
    h1{margin:0 0 6px}
    .sub{color:#666;font-size:13px;margin-bottom:16px}
    a.btn,button.btn{display:inline-block;padding:6px 10px;border:1px solid #ddd;border-radius:6px;text-decoration:none}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #ddd;padding:8px;vertical-align:top}
    th{text-align:left;background:#f6f6f6}
    .muted{color:#666;font-size:12px}
    .badge{display:inline-block;padding:2px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px}
    #topbar{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  </style>
</head>
<body>
  <div id="topbar">
    <a class="btn" href="/static/travelers.html">← Travelers</a>
    <span id="title" style="font-weight:700"></span>
    <span id="status" class="muted">Loading…</span>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th style="width:70px">Seq</th>
        <th>Step Code</th>
        <th>Step Name</th>
        <th>Station</th>
        <th>Status</th>
        <th>Operator</th>
        <th>QA Req</th>
        <th>QA Result</th>
        <th>Started</th>
        <th>Finished</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const qs = new URLSearchParams(location.search);
const travelerId = qs.get('traveler_id');
const statusEl = document.getElementById('status');
const titleEl  = document.getElementById('title');
const tbody    = document.querySelector('#tbl tbody');

if(!travelerId){
  statusEl.textContent = 'Missing ?traveler_id=…';
} else {
  titleEl.textContent = `Traveler #${travelerId} — Steps`;
  loadSteps(travelerId);
}

function esc(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function fmtDate(v){ try{ return v ? new Date(v).toLocaleString() : ""; }catch(e){ return v||""; } }

async function loadSteps(id){
  statusEl.textContent = 'Loading…';
  tbody.innerHTML = '';
  try{
    const res = await fetch(`/traveler-steps?traveler_id=${encodeURIComponent(id)}`);
    if(!res.ok) throw new Error(await res.text());
    const data = await res.json();
    if(!Array.isArray(data) || data.length===0){
      statusEl.textContent = 'No steps for this traveler.';
      return;
    }
    for(const s of data){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${s.seq ?? ''}</td>
        <td>${esc(s.step_code ?? '')}</td>
        <td>${esc(s.step_name ?? '')}</td>
        <td>${esc(s.station ?? '')}</td>
        <td><span class="badge">${esc(s.status ?? '')}</span></td>
        <td>${s.operator_id ?? ''}</td>
        <td>${s.qa_required ? 'Yes' : 'No'}</td>
        <td>${esc(s.qa_result ?? '')}</td>
        <td>${fmtDate(s.started_at)}</td>
        <td>${fmtDate(s.finished_at)}</td>
      `;
      tbody.appendChild(tr);
    }
    statusEl.textContent = `${data.length} step(s) loaded.`;
  }catch(err){
    console.error(err);
    statusEl.textContent = 'Failed to load: ' + err;
  }
}
</script>
</body>
</html>
