<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Employee Detail ¬∑ Topnotch MFG</title>
    <link rel="stylesheet" href="/static/css/app.css" />
    <style>
      /* light page-specific styling (safe to remove if app.css already covers) */
      .page-title {
        margin: 0 0 12px;
      }
      .card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        margin: 16px 0;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(12, minmax(0, 1fr));
        gap: 12px;
      }
      .col-12 {
        grid-column: span 12;
      }
      .col-6 {
        grid-column: span 6;
      }
      .col-4 {
        grid-column: span 4;
      }
      .col-3 {
        grid-column: span 3;
      }
      .btn {
        border: 1px solid #d1d5db;
        background: #f3f4f6;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
      }
      .btn:hover {
        background: #e5e7eb;
      }
      .btn-primary {
        background: #2563eb;
        border-color: #1d4ed8;
        color: #fff;
      }
      .btn-primary:hover {
        background: #1d4ed8;
      }
      .btn-danger {
        background: #ef4444;
        border-color: #dc2626;
        color: #fff;
      }
      .btn-danger:hover {
        background: #dc2626;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      input,
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
      }
      .muted {
        color: #6b7280;
      }
      .topbar {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 8px 0;
      }
      .search {
        display: flex;
        gap: 6px;
        align-items: center;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 4px 8px;
      }
      .search input {
        border: 0;
        outline: 0;
      }
      .logo {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        padding: 12px;
      }
      .logo-badge {
        display: inline-grid;
        place-items: center;
        width: 28px;
        height: 28px;
        border-radius: 8px;
        background: #111;
        color: #fff;
        font-size: 12px;
      }
      .app {
        display: grid;
        grid-template-columns: 260px 1fr;
        min-height: 100vh;
        background: #f7f7f8;
      }
      .sidebar {
        background: #fff;
        border-right: 1px solid #e5e7eb;
      }
      .main {
        padding: 16px;
      }
      .kv {
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 6px 12px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div id="navSlot" data-nav-slot></div>
      </aside>

      <!-- Main -->
      <main class="main">
        <!-- Topbar -->
        <div class="topbar">
          <div class="search">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="currentColor"
              aria-hidden="true"
            >
              <path
                d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zM9.5 14C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
              />
            </svg>
            <input id="globalSearch" type="search" placeholder="Search‚Ä¶" />
          </div>
          <input id="apiBase" placeholder="API Base (default /api/v1)" />
          <button class="btn" id="btnPing" type="button">Ping</button>
        </div>

        <!-- Page -->
        <section id="page-employee-detail">
          <h2 class="page-title">üë©‚Äçüè≠ Employee Detail</h2>

          <!-- Meta / breadcrumbs -->
          <div class="kv muted">
            <div>Employee ID</div>
            <div id="meta_id">‚Äî</div>
            <div>URL</div>
            <div id="meta_url">‚Äî</div>
          </div>

          <!-- Form -->
          <div class="card">
            <div class="grid">
              <div class="col-3">
                <label>Employee Code</label>
                <input id="d_emp_code" placeholder="EMP-2025-001" />
                <div class="muted" style="font-size: 12px">
                  ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥)
                </div>
              </div>
              <div class="col-6">
                <label>Full Name</label>
                <input id="d_name" placeholder="Jane Doe" />
              </div>
              <div class="col-3">
                <label>Status</label>
                <select id="d_status">
                  <option value="active">active</option>
                  <option value="inactive">inactive</option>
                  <option value="terminated">terminated</option>
                </select>
              </div>

              <div class="col-4">
                <label>Email</label>
                <input id="d_email" placeholder="jane@company.com" />
              </div>
              <div class="col-4">
                <label>Phone</label>
                <input id="d_phone" placeholder="+66 8x-xxx-xxxx" />
              </div>
              <div class="col-4">
                <label>Department</label>
                <input id="d_department" placeholder="Machining / QA / Admin" />
              </div>

              <div class="col-6">
                <label>Position</label>
                <input
                  id="d_position"
                  placeholder="Operator / QA / Supervisor"
                />
              </div>
            </div>

            <div class="toolbar" style="margin-top: 16px">
              <button class="btn" id="btnBack" type="button">‚Üê Back</button>
              <div style="flex: 1"></div>
              <button class="btn btn-danger" id="btnDelete" type="button">
                Delete
              </button>
              <button class="btn btn-primary" id="btnSave" type="button">
                Save
              </button>
            </div>
            <div class="muted" style="margin-top: 8px">
              GET / PUT / DELETE /employees/{id}
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast" role="status" aria-live="polite">
      <span id="toastText"></span>
    </div>

    <!-- Load sidebar nav + topbar init -->
    <script type="module" src="/static/js/nav-loader.js"></script>

    <!-- Page logic -->
    <script type="module">
      import { jfetch, showToast as toast } from "/static/js/api.js?v=4";

      /* ------------- helpers ------------- */
      const $ = (id) => document.getElementById(id);
      const esc = (s) =>
        String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      const strOrNull = (v) => {
        if (v == null) return null;
        const s = String(v).trim();
        return s === "" ? null : s;
      };

      const qs = new URLSearchParams(location.search);
      const empId = Number(qs.get("id"));

      function setDisabled(disabled = true) {
        [
          "d_emp_code",
          "d_name",
          "d_email",
          "d_phone",
          "d_position",
          "d_department",
          "d_status",
          "btnSave",
          "btnDelete",
        ].forEach((id) => {
          const el = $(id);
          if (el) el.disabled = disabled;
        });
      }

      function fillForm(e) {
        $("meta_id").textContent = String(e.id);
        $("meta_url").textContent = location.href;

        $("d_emp_code").value = e.emp_code ?? "";
        $("d_name").value = e.name ?? "";
        $("d_email").value = e.email ?? "";
        $("d_phone").value = e.phone ?? "";
        $("d_position").value = e.position ?? "";
        $("d_department").value = e.department ?? "";
        $("d_status").value = e.status ?? "active";
      }

      function collectPayload() {
        const emp_code = strOrNull($("d_emp_code").value);
        const name = strOrNull($("d_name").value);
        const email = strOrNull($("d_email").value);
        const phone = strOrNull($("d_phone").value);
        const position = strOrNull($("d_position").value);
        const department = strOrNull($("d_department").value);
        const status = strOrNull($("d_status").value);

        return { emp_code, name, email, phone, position, department, status };
      }

      async function loadEmployee() {
        if (!empId || Number.isNaN(empId)) {
          toast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (query ?id=...)", false);
          setDisabled(true);
          return;
        }
        setDisabled(true);
        try {
          const e = await jfetch(`/employees/${empId}`);
          fillForm(e);
          setDisabled(false);
        } catch (err) {
          toast("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message, false);
          setDisabled(true);
        }
      }

      async function save() {
        const payload = collectPayload();

        // lightweight validation
        if (!payload.name) {
          toast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô", false);
          $("d_name").focus();
          return;
        }

        setDisabled(true);
        try {
          const updated = await jfetch(`/employees/${empId}`, {
            method: "PUT",
            body: JSON.stringify(payload),
          });
          fillForm(updated);
          toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        } catch (err) {
          toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message, false);
        } finally {
          setDisabled(false);
        }
      }

      async function removeEmployee() {
        if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ?")) return;
        setDisabled(true);
        try {
          await jfetch(`/employees/${empId}`, { method: "DELETE" });
          toast("‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          // go back to list
          location.href = "./employees.html";
        } catch (err) {
          toast("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message, false);
          setDisabled(false);
        }
      }

      /* ------------- bindings ------------- */
      document.addEventListener("DOMContentLoaded", () => {
        $("btnBack")?.addEventListener("click", () =>
          history.length > 1
            ? history.back()
            : (location.href = "./employees.html")
        );
        $("btnSave")?.addEventListener("click", save);
        $("btnDelete")?.addEventListener("click", removeEmployee);

        // disable inputs until data loaded
        setDisabled(true);
        loadEmployee();
      });
    </script>
  </body>
</html>
