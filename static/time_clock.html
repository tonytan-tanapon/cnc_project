<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
      Kiosk — Time Clock (online only)
    </title>
    <style>
      :root {
        --bg: #fff;
        --text: #111;
        --muted: #6b7280;
        --line: #e5e7eb;
        --shadow: 0 2px 10px rgba(0, 0, 0, 0.07);
        --in: #10b981;
        --out: #ef4444;
        --sbr: #f59e0b;
        --ebr: #6366f1;
        --disabled: #e5e7eb;

        /* Action button sizing */
        --btn-min: 220px;
        --btn-vh: 24vh;
        --btn-max: 360px;
        --btn-radius: 12px;

        --btn-fs-min: 42px;
        --btn-fs-vw: 4.8vw;
        --btn-fs-max: 84px;
      }

      * { box-sizing: border-box; }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font: 20px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial;
      }
      .wrap { max-width: 980px; margin: 24px auto; padding: 0 14px; }
      h1 { margin: 0 0 16px; font-size: 28px; }
      .muted { color: var(--muted); }

      /* View toggling */
      .view { display: none; }
      .view.active { display: block; }

      /* Panels & rows */
      .panel {
        background: #fff;
        border: 2px solid var(--line);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 16px;
      }
      .row { display: flex; gap: 12px; align-items: center; }

      /* Top display strip */
      .display {
        font-size: 28px; font-weight: 700;
        border: 2px solid var(--line); border-radius: 12px;
        padding: 12px 14px; min-height: 56px;
        display: flex; align-items: center; justify-content: space-between; gap: 20px;
      }
      .display span.value {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      }

      /* Keypad */
      .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px; }
      .key {
        font-size: 32px; font-weight: 700; border: 2px solid var(--line);
        border-radius: 10px; padding: 22px 0; background: #fff; cursor: pointer;
      }
      .key:active { transform: scale(0.98); }

      /* Status chip */
      .chip { display: inline-flex; align-items: center; gap: 8px; border: 2px solid var(--line); border-radius: 999px; padding: 6px 12px; font-size: 16px; }
      .dot { width: 14px; height: 14px; border-radius: 999px; display: inline-block; }
      .dot.off { background: #9ca3af; }
      .dot.in { background: #16a34a; }
      .dot.break { background: #d97706; }

      /* Button layout */
      .grid-actions { display: grid; grid-template-columns: 1fr; gap: 16px; }

      /* BIG ACTION BUTTONS */
      .bigbtn {
        display: flex; align-items: center; justify-content: center;
        border: 2px solid transparent; border-radius: var(--btn-radius);
        min-height: clamp(var(--btn-min), var(--btn-vh), var(--btn-max));
        padding: 36px 28px; font-weight: 800; color: #fff; box-shadow: var(--shadow);
        cursor: pointer;
        font-size: clamp(var(--btn-fs-min), var(--btn-fs-vw), var(--btn-fs-max));
        line-height: 1.1; white-space: normal; text-wrap: balance; gap: 14px;
      }
      .bigbtn .ico { width: 1.6em; height: 1.6em; flex: 0 0 auto; stroke-width: 2.2; }
      .bigbtn:hover:not([disabled]) { filter: saturate(1.08) brightness(0.98); }
      .bigbtn:active:not([disabled]) { transform: scale(0.98); filter: brightness(0.92); }
      .bigbtn:focus-visible { outline: 3px solid rgba(0,0,0,0.2); outline-offset: 2px; }
      .bigbtn[disabled] {
        background: var(--disabled); color: #9ca3af; cursor: not-allowed; box-shadow: none; transform: none;
      }

      /* Action colors */
      .btn-in { background: var(--in); }
      .btn-sbr { background: var(--sbr); }
      .btn-ebr { background: var(--ebr); }
      .btn-out { background: var(--out); }

      /* Table & badges */
      table { border-collapse: collapse; width: 100%; font-size: 18px; }
      th, td { padding: 10px; border-bottom: 1px solid var(--line); text-align: left; }
      th { background: #f9fafb; }
      .badge { display: inline-block; padding: 4px 8px; border-radius: 999px; font-size: 14px; color: #fff; }
      .b-in { background: var(--in); }
      .b-out { background: var(--out); }
      .b-sbr { background: var(--sbr); }
      .b-ebr { background: var(--ebr); }

      /* Passcode dots */
      .passdots { display: flex; gap: 14px; align-items: center; justify-content: center; width: 100%; }
      .passdot { width: 16px; height: 16px; border-radius: 999px; border: 2px solid var(--line); }
      .passdot.filled { background: #111; border-color: #111; }

      /* Topbar */
      #top_title { font-weight: 700; font-size: 22px; }
      #id_val { flex: 1; display: flex; justify-content: center; letter-spacing: 3px; }
      #clock { font-size: 20px; font-weight: 600; white-space: nowrap; }

      /* Row for Start Break + Clock Out side-by-side */
      .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      .row-2:has(.bigbtn[style*="display: none"]) .bigbtn:not([style*="display: none"]) { grid-column: 1 / -1; }

      /* Mobile */
      @media (max-width: 540px) { .row-2 { grid-template-columns: 1fr; } }

      /* Exit overlay */
      .exitmask {
        position: fixed; inset: 0; display: none;
        align-items: center; justify-content: center;
        background: rgba(255,255,255,0.82); backdrop-filter: blur(2px);
        z-index: 9999; text-align: center; padding: 24px;
        font-weight: 800; font-size: 26px; color: #111;
      }
      .exitmask .sub { display:block; margin-top: 8px; font-weight: 600; font-size: 18px; color: var(--muted); }
    </style>
  </head>
  <body>
    <!-- View 1: 4-digit User ID -->
    <section id="v_id" class="view active">
      <div class="panel">
        <div class="display" style="margin-top: 12px">
          <span id="top_title">TopNotch v1.0</span>
          <span id="id_val" class="passdots" aria-label="Enter 4-digit code" aria-live="polite"></span>
          <span id="clock" aria-live="polite"></span>
        </div>
        <div class="keypad" id="id_pad" style="margin-top: 16px"></div>
      </div>
    </section>

    <!-- View 2: Actions -->
    <section id="v_act" class="view">
      <div class="panel">
        <div class="row" style="justify-content: space-between; gap: 16px; flex-wrap: wrap">
          <div><div style="font-size: 22px; font-weight: 800">Welcome, <span id="emp_name"></span></div></div>
          <div class="chip" id="chip">
            <span class="dot off"></span>
            <span id="chip_status">Off Duty</span>
            <span id="chip_time" style="margin-left: 8px; font-weight: 600; font-size: 16px"></span>
          </div>
        </div>

        <div class="grid-actions" style="margin-top: 16px">
          <button class="bigbtn btn-in" id="btn_in">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 4v16"></path><path d="M10 12h10"></path><path d="M16 8l4 4-4 4"></path>
            </svg><span>Clock In</span>
          </button>

          <div class="row-2">
            <button class="bigbtn btn-sbr" id="btn_sbr">
              <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="10" width="12" height="6" rx="2"></rect>
                <path d="M15 11h3a2 2 0 0 1 0 4h-3"></path>
                <path d="M7 7v2M9 6v2M11 7v2"></path>
              </svg><span>Start Break</span>
            </button>

            <button class="bigbtn btn-out" id="btn_out">
              <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 4v16"></path><path d="M14 12H4"></path><path d="M8 8l-4 4 4 4"></path>
              </svg><span>Clock Out</span>
            </button>
          </div>

          <button class="bigbtn btn-ebr" id="btn_ebr">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="8" width="18" height="12" rx="2"></rect>
              <path d="M9 8V6h6v2"></path>
              <path d="M3 13h18"></path>
            </svg><span>Stop Break</span>
          </button>
        </div>

        <div class="row" style="justify-content: space-between; margin-top: 16px">
          <button class="key action" id="btn_logout" style="padding: 12px 16px">Logout</button>
        </div>
      </div>

      <div class="panel" style="margin-top: 16px">
  <div style="font-size: 22px; font-weight: 700; margin-bottom: 8px">
    Work Summary (Past 30 Days)
  </div>
  <table>
    <thead>
      <tr>
        <th style="width: 140px">Date</th>
        <th style="width: 120px">Clock In</th>
        <th style="width: 120px">Start Break</th>
        <th style="width: 120px">Stop Break</th>
        <th style="width: 120px">Clock Out</th>
        <!-- <th style="width: 80px">Hrs</th> -->
      </tr>
    </thead>
    <tbody id="log"></tbody>
  </table>
</div>


    </section>

    <!-- Exit overlay -->
    <div id="exitmask" class="exitmask" aria-live="polite">
      Saving…<span class="sub">Please wait</span>
    </div>

    <script type="module">
      import { $, jfetch, toast } from "/static/js/api.js?v=1";

      /* ----------------- API base ----------------- */
      const API_BASE = ""; // same origin as your kiosk.html
      const api = (p) => `${API_BASE}${p}`;

      /* ----------------- Los Angeles timezone helpers ----------------- */
      const LA_TZ = "America/Los_Angeles";
      function laOffsetMs(d = new Date()) {
        const laStr = d.toLocaleString("en-US", { timeZone: LA_TZ });
        const laAsLocal = new Date(laStr);
        return laAsLocal.getTime() - d.getTime();
      }
      function toLA(d = new Date()) { return new Date(d.getTime() + laOffsetMs(d)); }
      function fromLA(laDate) { return new Date(laDate.getTime() - laOffsetMs(laDate)); }
      function startOfTodayISO_LA() {
        const laNow = toLA(new Date());
        const laStart = new Date(laNow.getFullYear(), laNow.getMonth(), laNow.getDate(), 0, 0, 0, 0);
        return fromLA(laStart).toISOString();
      }
      function startOfTomorrowISO_LA() {
        const laNow = toLA(new Date());
        const laStart = new Date(laNow.getFullYear(), laNow.getMonth(), laNow.getDate() + 1, 0, 0, 0, 0);
        return fromLA(laStart).toISOString();
      }
      function startOf30DaysAgoISO_LA() {
  const laNow = toLA(new Date());
  const laStart = new Date(laNow.getFullYear(), laNow.getMonth(), laNow.getDate() - 30, 0, 0, 0, 0);
  return fromLA(laStart).toISOString();
}
      function fmtDateTimeLA(ts) {
        if (!ts) return "";
        const d = typeof ts === "string" ? new Date(ts) : ts;
        const la = toLA(d);
        const yyyy = la.getFullYear();
        const mm = String(la.getMonth() + 1).padStart(2, "0");
        const dd = String(la.getDate()).padStart(2, "0");
        const hh = String(la.getHours()).padStart(2, "0");
        const mi = String(la.getMinutes()).padStart(2, "0");
        const ss = String(la.getSeconds()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
      }
      function fmtTimeLA_AMPM(ts) {
  if (!ts) return "";
  const d = typeof ts === "string" ? new Date(ts) : ts;
  const la = toLA(d);
  return la.toLocaleTimeString("en-US", {
    hour: "numeric",
    minute: "2-digit",
    hour12: true,
    timeZone: "America/Los_Angeles",
  });
}
      function fmtClockLA() {
        const la = toLA(new Date());
        return la.toLocaleTimeString([], {
          hour: "2-digit", minute: "2-digit", second: "2-digit",
          hour12: true, timeZone: LA_TZ,
        });
      }

      /* ----------------- state ----------------- */
      const state = {
        code: "",
        idDigits: "",
        empName: "",
        employeeId: null,
        timeEntryId: null,
        breakId: null,
        status: "off",
        busy: false,
        hasBreakUsed: false,
        exiting: false,
      };

      /* ----------------- small helpers ----------------- */
      const pad = (n) => String(n).padStart(2, "0");
      const startOfTodayISO = startOfTodayISO_LA;
      const startOfTomorrowISO = startOfTomorrowISO_LA;

      const setView = (id) => {
        ["v_id", "v_act"].forEach((v) => $(v).classList.remove("active"));
        $(id).classList.add("active");
      };

      function hide(el) { if (!el) return; if (document.activeElement === el) el.blur(); el.style.display = "none"; }
      function show(el) { if (!el) return; el.style.display = ""; }

      function setChip(status) {
        const dot = document.querySelector("#chip .dot");
        const txt = document.getElementById("chip_status");
        const timeEl = document.getElementById("chip_time");
        dot.className = "dot " + (status || "off");
        txt.textContent =
          status === "in" ? "Clocked In" :
          status === "break" ? "On Break" : "Off Duty";
        timeEl.textContent = fmtClockLA();
      }

      // Clear PIN dots/title/name when leaving to PIN
      function resetLoginUI() {
        state.idDigits = "";
        renderIdDots();
        const title = document.getElementById("top_title");
        if (title) title.textContent = "TopNotch v1.0";
        const nameEl = $("emp_name");
        if (nameEl) nameEl.textContent = "";
        setChip("off");
      }

      // Fast exit: go to PIN immediately and block input
      function beginSubmitAndLeaveView(msg = "Saving…") {
        state.exiting = true;
        const mask = $("exitmask");
        if (mask) {
          mask.firstChild.nodeValue = msg;
          mask.style.display = "flex";
        }
        document.querySelectorAll(".bigbtn, #btn_logout").forEach((b) => {
          b.setAttribute("disabled", "true");
          b.style.pointerEvents = "none";
          b.style.visibility = "hidden";
        });
        setView("v_id");
      }
      function leaveExitMode() {
        state.exiting = false;
        const mask = $("exitmask");
        if (mask) mask.style.display = "none";
        document.querySelectorAll(".bigbtn, #btn_logout").forEach((b) => {
          b.removeAttribute("disabled");
          b.style.pointerEvents = "";
          b.style.visibility = "";
        });
      }

      /* ----------------- UI logic (hide/show buttons) ----------------- */
      function updateButtons() {
        if (state.exiting) {
          ["btn_in","btn_out","btn_sbr","btn_ebr"].forEach((id) => hide($(id)));
          return;
        }
        const inBtn = $("btn_in");
        const outBtn = $("btn_out");
        const sbrBtn = $("btn_sbr");
        const ebrBtn = $("btn_ebr");
        [inBtn, outBtn, sbrBtn, ebrBtn].forEach(hide);

        const st = state.status; // 'off' | 'in' | 'break'
        const onBreak = !!state.breakId;
        const usedBreakThisShift = !!state.hasBreakUsed;

        if (st === "off") { show(inBtn); return; }
        if (st === "break" || onBreak) { show(ebrBtn); return; }
        if (usedBreakThisShift) { show(outBtn); }
        else { show(sbrBtn); show(outBtn); }
      }

      function logout() {
        setView("v_id");
        resetLoginUI();
        toast("Logged out");

        state.code = "";
        state.empName = "";
        state.employeeId = null;
        state.timeEntryId = null;
        state.breakId = null;
        state.status = "off";
        state.hasBreakUsed = false;

        leaveExitMode();
        updateButtons();
        renderLog([]);
      }

      /* ----------------- log renderer ----------------- */
 /* ----------------- render summarized daily log with weekly separators ----------------- */
function renderLog(rows) {
  const tb = $("log");
  if (!rows || rows.length === 0) {
    tb.innerHTML = `<tr><td colspan="6"><span class="muted">No records in the past 30 days</span></td></tr>`;
    return;
  }

  let html = "";
  let lastWeek = null;

  for (const r of rows) {
    const d = new Date(r.date);
    const weekYear = `${d.getFullYear()}-${getWeekNumber(d)}`;
    const isNewWeek = weekYear !== lastWeek;
    lastWeek = weekYear;

    if (isNewWeek && html !== "") {
      html += `<tr><td colspan="6" style="border-top: 3px solid #000;"></td></tr>`;
    }

    // Format total hours (HH:MM)
    let hrmin = "";
    if (typeof r.total_hours === "number") {
      const hrs = Math.floor(r.total_hours);
      const mins = Math.round((r.total_hours - hrs) * 60);
      hrmin = `${hrs}:${String(mins).padStart(2, "0")}`;
    } else if (typeof r.total_hours === "string" && r.total_hours.includes(":")) {
      hrmin = r.total_hours; // already formatted
    }

    html += `
      <tr>
        <td style="font-weight:600">${r.date}</td>
        <td>${r.clock_in || ""}</td>
        <td>${r.start_break || ""}</td>
        <td>${r.stop_break || ""}</td>
        <td>${r.clock_out || ""}</td>
        <td>${hrmin}</td>
      </tr>
    `;
  }

  tb.innerHTML = html;
}

/* ----------------- helper to get ISO week number ----------------- */
function getWeekNumber(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
}

/* ----------------- fetch 30-day log and summarize ----------------- */
async function fetchTodayLog() {
  if (!state.employeeId) {
    renderLog([]);
    updateButtons();
    return;
  }

  const qs = new URLSearchParams({
    employee_id: String(state.employeeId),
    start_at: startOf30DaysAgoISO_LA(),
    end_at: startOfTomorrowISO(),
  }).toString();

  try {
    let rows;
    try { rows = await jfetch(api(`/time-entries/range?${qs}`)); }
    catch { rows = await jfetch(api(`/time-entries?${qs}`)); }

    const summaries = [];

    for (const te of rows) {
      const d = toLA(new Date(te.clock_in_at || te.clock_out_at));
      const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
      const clock_in = te.clock_in_at ? fmtTimeLA_AMPM(te.clock_in_at) : "";
const clock_out = te.clock_out_at ? fmtTimeLA_AMPM(te.clock_out_at) : "";
let start_break = "", stop_break = "";
if (Array.isArray(te.breaks) && te.breaks.length > 0) {
  const br = te.breaks[0];
  start_break = br.start_at ? fmtTimeLA_AMPM(br.start_at) : "";
  stop_break = br.end_at ? fmtTimeLA_AMPM(br.end_at) : "";
}

      // compute hours (exclude break)
      let hrs = "";
      if (te.clock_in_at && te.clock_out_at) {
        const inT = new Date(te.clock_in_at);
        const outT = new Date(te.clock_out_at);
        let diff = (outT - inT) / 3600000; // total hrs
        if (Array.isArray(te.breaks)) {
          for (const br of te.breaks) {
            if (br.start_at && br.end_at) {
              diff -= (new Date(br.end_at) - new Date(br.start_at)) / 3600000;
            }
          }
        }
        hrs = diff.toFixed(2);
      }

      summaries.push({
        date: dateStr,
        clock_in,
        start_break,
        stop_break,
        clock_out,
        total_hours: hrs,
      });
    }

    // Sort by most recent date
    summaries.sort((a, b) => new Date(b.date) - new Date(a.date));
    renderLog(summaries);
    updateButtons();
  } catch (e) {
    renderLog([]);
    updateButtons();
    if (navigator.onLine) toast(e.message || "Load log failed", false);
  }
}



      /* ----------------- server state ----------------- */
      async function fetchStateByCode(code) {
        const data = await jfetch(api(`/time-entries/state/${encodeURIComponent(code)}`));
        state.status = data.status || "off";
        state.timeEntryId = data.time_entry_id || null;
        state.breakId = data.break_id || null;
        state.employeeId = data.employee_id || null;
        state.empName = data.name || state.empName || "Employee";

        $("emp_name").textContent = state.empName;
        const title = document.getElementById("top_title");
        if (title) title.textContent = `TopNotch v1.0 — ${state.empName}`;

        setChip(state.status);
        updateButtons();
        await fetchTodayLog();
      }

      /* ----------------- actions (online only) ----------------- */
      async function clockIn() {
        if (state.busy) return;
        state.busy = true;
        beginSubmitAndLeaveView("Saving Clock In…");
        try {
          const payload = { code: state.code, method: "web" };
          if (state.employeeId) payload.employee_id = state.employeeId;
          await jfetch(api("/time-entries/start"), { method: "POST", body: JSON.stringify(payload) });

          toast("Clocked in");
          state.code = "";
          state.idDigits = "";
          resetLoginUI();
        } catch (e) {
          leaveExitMode();
          setView("v_act");
          state.busy = false;
          toast(e.message || "Clock in failed", false);
          return;
        }
        state.busy = false;
        leaveExitMode();
      }

      async function clockOut() {
        if (state.busy) return;
        state.busy = true;
        beginSubmitAndLeaveView("Saving Clock Out…");
        try {
          await jfetch(api("/time-entries/stop"), { method: "POST", body: JSON.stringify({ code: state.code, method: "web" }) });

          state.status = "off";
          state.timeEntryId = null;
          state.breakId = null;
          state.hasBreakUsed = false;

          toast("Clocked out");
          state.code = "";
          state.idDigits = "";
          resetLoginUI();
        } catch (e) {
          leaveExitMode();
          setView("v_act");
          state.busy = false;
          toast(e.message || "Clock out failed", false);
          return;
        }
        state.busy = false;
        leaveExitMode();
      }

      async function startBreak() {
        if (state.busy) return;
        state.busy = true;
        beginSubmitAndLeaveView("Saving Break Start…");
        try {
          await jfetch(api("/breaks/start"), { method: "POST", body: JSON.stringify({ code: state.code, break_type: "lunch", is_paid: false, method: "web" }) });

          toast("Break started");
          state.code = "";
          state.idDigits = "";
          resetLoginUI();
        } catch (e) {
          leaveExitMode();
          setView("v_act");
          state.busy = false;
          toast(e.message || "Start break failed", false);
          return;
        }
        state.busy = false;
        leaveExitMode();
      }

      async function stopBreak() {
        if (state.busy) return;
        state.busy = true;
        beginSubmitAndLeaveView("Saving Break Stop…");
        try {
          await jfetch(api("/breaks/stop"), { method: "POST", body: JSON.stringify({ code: state.code }) });

          toast("Break stopped");
          state.code = "";
          state.idDigits = "";
          resetLoginUI();
        } catch (e) {
          leaveExitMode();
          setView("v_act");
          state.busy = false;
          toast(e.message || "Stop break failed", false);
          return;
        }
        state.busy = false;
        leaveExitMode();
      }

      /* ----------------- keypad ----------------- */
      function renderPad(el) {
        const keys = ["1","2","3","4","5","6","7","8","9","⌫","0","Clear"];
        el.innerHTML = keys.map(
          (k) => `<button class="key${isNaN(+k) ? " action" : ""}" data-k="${k}">${k}</button>`
        ).join("");
        el.addEventListener("click", async (e) => {
          const b = e.target.closest("button[data-k]");
          if (!b) return;
          const k = b.dataset.k;
          if (!isNaN(+k)) state.idDigits = (state.idDigits + k).slice(0, 4);
          else if (k === "⌫") state.idDigits = state.idDigits.slice(0, -1);
          else state.idDigits = "";
          renderIdDots();
          if (state.idDigits.length === 4) {
            await handleFourDigits(state.idDigits);
          }
        });
      }

      async function handleFourDigits(code) {
        try {
          await fetchStateByCode(code);
          state.code = code;
          setView("v_act");
        } catch (e) {
          toast(e.message || "Invalid code", false);
          clearId();
        }
      }

      function clearId() {
        state.idDigits = "";
        renderIdDots();
      }

      /* ----------------- boot ----------------- */
      document.addEventListener("DOMContentLoaded", () => {
        renderPad($("id_pad"));
        renderIdDots();
        startClock();
        $("btn_in").addEventListener("click", clockIn);
        $("btn_out").addEventListener("click", clockOut);
        $("btn_sbr").addEventListener("click", startBreak);
        $("btn_ebr").addEventListener("click", stopBreak);
        $("btn_logout").addEventListener("click", () => {
          if (!state.exiting) logout();
        });
        updateButtons();
        startChipClock();
      });

      function renderIdDots() {
        const n = state.idDigits.length;
        const dots = Array.from({ length: 4 }, (_, i) =>
          `<span class="passdot${i < n ? " filled" : ""}"></span>`).join("");
        $("id_val").innerHTML = dots;
      }

      function startClock() {
        const el = document.getElementById("clock");
        const tick = () => { el.textContent = fmtClockLA(); };
        tick(); return setInterval(tick, 1000);
      }

      function startChipClock() {
        const timeEl = document.getElementById("chip_time");
        if (!timeEl) return;
        setInterval(() => { timeEl.textContent = fmtClockLA(); }, 1000);
      }
    </script>
  </body>
</html>
