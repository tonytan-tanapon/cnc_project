<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Employee Timesheet</title>
  <style>
    :root{ --line:#e5e7eb; --muted:#6b7280 }
    body{ font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; padding:20px }
    h1{ margin:0 0 8px; font-size:22px }
    .muted{ color:var(--muted); font-size:13px; margin-bottom:4px }
    input[type="number"]{ width:110px; text-align:right; padding:6px 8px; border:1px solid var(--line); border-radius:8px }
    button{ padding:8px 12px; border:1px solid var(--line); border-radius:8px; background:#111; color:#fff; cursor:pointer }
    table{ border-collapse:collapse; width:100%; margin-top:12px }
    th,td{ border:1px solid var(--line); padding:6px 8px; text-align:center; vertical-align:top }
    th{ background:#f8fafc }
    .num{ text-align:right }
    .left{ text-align:left }
    .nowrap{ white-space:nowrap }
    .mono{ font-variant-numeric: tabular-nums }
    .empty{ color:var(--muted); padding:10px }
    .page-header{ display:flex; align-items:center; gap:12px; margin:0 0 8px; }
    .back-link{ margin-left:auto; text-decoration:none; color:#2563eb; font-weight:600; }
    .back-link:hover{ text-decoration:underline; }
    .bar{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin:12px 0; justify-content:flex-end; }
    .link{ color:#2563eb; text-decoration:none; font-weight:600 }
    .link:hover{ text-decoration:underline }
  </style>
</head>
<body>
  <div class="page-header">
    <h1 id="header">Payroll</h1>
    <a class="back-link" href="payroll_period_employees.html">← Back</a>
  </div>

  <table>
    <thead>
      <tr>
        <th>No</th>                <!-- NEW: clickable -->
        <th>Date</th>
        <th>Shifts</th>
        <th>Breaks</th>
        <th>Break (hrs)*</th>
        <th>Reg (hrs)</th>
        <th>OT (hrs)</th>
        <th>Rate</th>
        <th>OT Rate</th>
        <th>Pay (Reg)</th>
        <th>Pay (OT)</th>
        <th>Total Pay</th>
      </tr>
    </thead>
    <tbody id="tblBody"><tr><td colspan="12" class="empty">Loading…</td></tr></tbody>
    <tfoot id="tblFoot"></tfoot>
  </table>
  <div class="muted" style="margin-top:4px">* Unpaid break hours</div>
  <div class="bar">
    <label>Rate:
      <input id="rate" type="number" step="0.01" min="0" value="20.00" inputmode="decimal">
    </label>
    <label>OT Rate: <input id="ot_rate" type="number" step="0.01" placeholder="default 1.5×"></label>
    <button id="recalc">calculate</button>
    <button id="exportCsv">Export CSV</button>
  </div>

  <script type="module">
  import { $ as _$$, jfetch, toast } from "/static/js/api.js?v=1";
  const $ = (sel)=>document.querySelector(sel);

  const API_BASE = '';
  const api = (p) => `${API_BASE}${p}`;
  async function apiGET(path){ try{ return await jfetch(api(path)); }catch(e){ console.error(e); toast?.(e?.message||'API error'); throw e; } }

  const PP  = "/pay-periods";
  const EMP = "/employees";
  const DEFAULT_OT_MULTIPLIER = 1.5;

  const pad = n=>String(n).padStart(2,'0');
  const fmtDate = iso => iso ? new Date(iso).toISOString().slice(0,10) : '';
  const fmtTime = iso => { if(!iso) return ''; const d=new Date(iso); return `${pad(d.getHours())}:${pad(d.getMinutes())}`; };
  const currency = v =>
  new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 })
    .format(Number(v ?? 0));
  const getQS = k => new URL(location.href).searchParams.get(k);
  const utcDateKey = iso => iso ? new Date(iso).toISOString().slice(0,10) : null;
  
  
  // cache
  let lastSummary = null, lastBreaksByDate = {}, lastShiftsByDate = {};
  let currentEmployeeId = null, currentPpId = null;
  let currentEmpName = '', currentPpStart = '', currentPpEnd = '';
  async function safeGetPayPeriod(pp_id){
    try{ const pp = await apiGET(`${PP}/${pp_id}`); if(pp) return pp; }catch{}
    const all = await apiGET(PP);
    const found = (all||[]).find(x=>String(x.id)===String(pp_id));
    if(!found) throw new Error(`PayPeriod id=${pp_id} not found`); return found;
  }

  function effectiveRates(){
    const r = Number($('#rate').value || 0);
    const otField = $('#ot_rate').value;
    const ot = (otField === '' ? r * DEFAULT_OT_MULTIPLIER : Number(otField || 0));
    return { rate: r, otRate: ot };
  }

  function formatShiftsCell(list){
    if(!list || !list.length) return '';
    const sorted = [...list].sort((a,b)=>new Date(a.start_at||0) - new Date(b.start_at||0));
    return sorted.map(s=>{
      const si = fmtTime(s.start_at);
      const so = s.end_at ? fmtTime(s.end_at) : '…';
      return `${si}-${so}`;
    }).join('<br>');
  }

  function formatBreaksCell(list){
    if(!list || !list.length) return '';
    const sorted = [...list].sort((a,b)=>new Date(a.start_at||0) - new Date(b.start_at||0));
    return sorted.map(b=>{
      const s = fmtTime(b.start_at);
      const e = fmtTime(b.end_at);
      // const tag = (b.is_paid ? '' : ' (unpaid)');
      return `${s}-${e}`;
    }).join('<br>');
  }

  function render(summary, breaksByDate = {}, shiftsByDate = {}){
    const tb = $('#tblBody'); tb.innerHTML = '';
    const { rate, otRate } = effectiveRates();

    let sumReg=0, sumOT=0, sumPayReg=0, sumPayOT=0, idx=0;

    for(const row of (summary.rows || [])){
      idx += 1;

      const reg = Number(row.reg_hours || 0);
      const ot  = Number(row.ot_hours || 0);
      const payReg = reg * rate;
      const payOT  = ot  * otRate;

      sumReg+=reg; sumOT+=ot; sumPayReg+=payReg; sumPayOT+=payOT;

      const breaksTxt = formatBreaksCell(breaksByDate[row.date] || []);
      const shiftsTxt = formatShiftsCell(shiftsByDate[row.date] || []);

      // const editUrl = `employee_timesheet_edit.html?pp_id=${encodeURIComponent(currentPpId)}&employee_id=${encodeURIComponent(currentEmployeeId)}&date=${row.date}`;
      const editUrl = `employee_timesheet_edit.html?pp_id=${encodeURIComponent(currentPpId)}&employee_id=${encodeURIComponent(currentEmployeeId)}&date=${row.date}&return=${encodeURIComponent(location.href)}`;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="num mono"><a class="link" href="${editUrl}" title="Edit this day">${idx}</a></td>
        <td class="nowrap mono">${row.date}</td>
        <td class="left mono">${shiftsTxt}</td>
        <td class="left mono">${breaksTxt}</td>
        <td class="num mono">${Number(row.unpaid_break_hours||0).toFixed(2)}</td>
        <td class="num mono">${reg.toFixed(2)}</td>
        <td class="num mono">${ot.toFixed(2)}</td>
        <td class="num mono">${rate?currency(rate):''}</td>
        <td class="num mono">${otRate?currency(otRate):''}</td>
        <td class="num mono">${currency(payReg)}</td>
        <td class="num mono">${currency(payOT)}</td>
        <td class="num mono">${currency(payReg+payOT)}</td>`;
      tb.appendChild(tr);
    }

    $('#tblFoot').innerHTML = `
      <tr>
        <td colspan="5" class="num">Total</td>
        <td class="num mono">${sumReg.toFixed(2)}</td>
        <td class="num mono">${sumOT.toFixed(2)}</td>
        <td></td><td></td>
        <td class="num mono">${currency(sumPayReg)}</td>
        <td class="num mono">${currency(sumPayOT)}</td>
        <td class="num mono">${currency(sumPayReg+sumPayOT)}</td>
      </tr>`;
  }
  const safeFilename = (s) =>
  String(s ?? '')
    .normalize('NFKC')
    .replace(/[<>:"/\\|?*\x00-\x1F]/g, '')  // อักขระต้องห้ามบน Windows/macOS
    .replace(/\s+/g, '_')
    .slice(0, 120);
  function exportCSV(){
    const header = [
      'no','date','shifts','breaks',
      'break_unpaid_h','reg_h','ot_h','rate','ot_rate','pay_reg','pay_ot','pay_total'
    ];
    const rows = [];
    document.querySelectorAll('#tblBody tr').forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      rows.push([
        (tds[0]?.textContent||'').trim(),
        (tds[1]?.textContent||'').trim(),
        (tds[2]?.textContent||'').trim(),
        (tds[3]?.textContent||'').trim(),
        (tds[4]?.textContent||'').trim(),
        (tds[5]?.textContent||'').trim(),
        (tds[6]?.textContent||'').trim(),
        (tds[7]?.textContent||'').trim(),
        (tds[8]?.textContent||'').trim(),
        (tds[9]?.textContent||'').trim(),
        (tds[10]?.textContent||'').trim(),
        (tds[11]?.textContent||'').trim(),
      ]);
    });
    const csv = [header, ...rows]
      .map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(','))
      .join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url;
    // a.download = `timesheet_${new Date().toISOString().slice(0,10)}.csv`;
    const fname = `payroll_${safeFilename(currentEmpName)}_${currentPpStart}_${currentPpEnd}.csv`;
    a.download = fname;
    a.click(); URL.revokeObjectURL(url);
  }
  
  async function loadPage(fetchFromApi = true){
    const pp_id = getQS('pp_id');
    const employee_id = getQS('employee_id');
    currentPpId = pp_id; currentEmployeeId = employee_id;

    if(!pp_id || !employee_id){
      $('#tblBody').innerHTML = `<tr><td colspan="12" class="empty">pp_id and employee_id are required</td></tr>`;
      return;
    }

    let pp;
    try{ pp = await safeGetPayPeriod(pp_id); }
    catch(e){ $('#tblBody').innerHTML = `<tr><td colspan="12" class="empty">${e.message}</td></tr>`; return; }

    let emp=null; try{ emp = await apiGET(`${EMP}/${employee_id}`);}catch{}
    document.getElementById('header').textContent =
      `Payroll — ${emp?.name ?? ('Emp #'+employee_id)} (${fmtDate(pp.start_at)} → ${fmtDate(pp.end_at)})`;

    currentEmpName = emp?.name ?? `Emp_${employee_id}`;
    currentPpStart = fmtDate(pp.start_at); // YYYY-MM-DD
    currentPpEnd   = fmtDate(pp.end_at);   // YYYY-MM-DD
    if (fetchFromApi){
      const [summary, details] = await Promise.all([
        apiGET(`/payroll/pay-periods/${pp_id}/employees/${employee_id}/daily-summary?closed_only=false&ot_daily_threshold=8`),
        apiGET(`/payroll/time-entries/by-employee?employee_id=${employee_id}&pp_id=${pp_id}`)
      ]);
      const breaksByDate = {};
      const shiftsByDate = {};
      for(const te of (details || [])){
        const dayKey = utcDateKey(te.clock_in_at || te.clock_out_at);
        if(!dayKey) continue;
        (shiftsByDate[dayKey] ??= []).push({ start_at: te.clock_in_at, end_at: te.clock_out_at });
        for(const b of (te.breaks || [])){ (breaksByDate[dayKey] ??= []).push(b); }
      }
      lastSummary = summary; lastBreaksByDate = breaksByDate; lastShiftsByDate = shiftsByDate;
    }
    render(lastSummary, lastBreaksByDate, lastShiftsByDate);
  }

  document.getElementById('rate').addEventListener('input', ()=>{
    const r = Number(document.getElementById('rate').value || 0);
    const ot = document.getElementById('ot_rate');
    if (ot.value === '' || Number(ot.value) === 0){
      ot.placeholder = r ? (r * 1.5).toFixed(2) : 'default 1.5×';
    }
  });

  document.getElementById('recalc').addEventListener('click', ()=>{
    render(lastSummary, lastBreaksByDate, lastShiftsByDate);
  });
  document.getElementById('exportCsv').addEventListener('click', exportCSV);

  document.addEventListener('DOMContentLoaded', ()=>loadPage(true));
  </script>
</body>
</html>
