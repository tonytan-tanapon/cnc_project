<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Excel-like Grid</title>
  <link href="https://unpkg.com/tabulator-tables@5.6.2/dist/css/tabulator.min.css" rel="stylesheet">
  <style>
    body{font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", sans-serif; background:#f6f7fb; margin:0; padding:24px;}
    h2{margin:0 0 12px}
    .toolbar{display:flex; gap:8px; align-items:center; margin-bottom:12px;}
    #grid{height:70vh; background:#fff; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,.08)}
    .btn{padding:8px 12px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer}
    .btn:hover{background:#f2f2f2}
    input[type="text"]{padding:8px 12px; border:1px solid #ddd; border-radius:10px; min-width:260px;}
  </style>
</head>
<body>
  <h2>ตารางแบบ Excel (Sort / Filter / Edit / Export)</h2>

  <div class="toolbar">
    <input id="search" type="text" placeholder="ค้นหาทุกคอลัมน์..." />
    <button class="btn" id="btnCsv">Export CSV</button>
    <button class="btn" id="btnXlsx">Export XLSX</button>
    <button class="btn" id="btnPrint">พิมพ์</button>
    <button class="btn" id="btnReset">ล้างตัวกรอง</button>
  </div>

  <div id="grid"></div>

  <!-- libs -->
  <script src="https://unpkg.com/tabulator-tables@5.6.2/dist/js/tabulator.min.js"></script>
  <!-- สำหรับ export .xlsx -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    // ====== ตัวอย่างข้อมูลเริ่มต้น (ลองเล่นได้ทันที) ======
    const rows = [
      {id:1, po_number:"PO-10001", customer_name:"ACME",  order_date:"2025-08-10", amount:1290.50, status:"Open"},
      {id:2, po_number:"PO-10002", customer_name:"Beta",  order_date:"2025-08-12", amount:980.00,  status:"Closed"},
      {id:3, po_number:"PO-10003", customer_name:"Gamma", order_date:"2025-08-13", amount:250.75,  status:"Pending"},
      {id:4, po_number:"PO-10004", customer_name:"ACME",  order_date:"2025-08-15", amount:1999.99, status:"Open"},
    ];

    // ====== ตั้งตาราง ======
    const table = new Tabulator("#grid", {
      data: rows,                // เปลี่ยนเป็นโหลดจาก API ได้ (ดูฟังก์ชัน loadFromApi ด้านล่าง)
      layout: "fitDataStretch",
      height: "70vh",
      movableColumns: true,
      columnDefaults: { headerFilter: true }, // filter ที่หัวคอลัมน์ทุกอัน
      columns: [
        {title:"ID",       field:"id", width:80, sorter:"number", headerFilter:"number", hozAlign:"right", editor:"input"},
        {title:"PO #",     field:"po_number", sorter:"string", headerFilter:"input", editor:"input"},
        {title:"ลูกค้า",   field:"customer_name", sorter:"string", headerFilter:"input", editor:"input"},
        {title:"วันที่",    field:"order_date", sorter:"date", headerFilter:"input",
          formatter:"datetime", formatterParams:{inputFormat:"YYYY-MM-DD", outputFormat:"YYYY-MM-DD"}, editor:"input"},
        {title:"ยอดเงิน",  field:"amount", sorter:"number", headerFilter:"number",
          hozAlign:"right", editor:"number", bottomCalc:"sum"},
        {title:"สถานะ",    field:"status", headerFilter:"select",
          headerFilterParams:{values:true}, editor:"select", editorParams:{values:["Open","Closed","Pending"]}}
      ],
      pagination:"local",
      paginationSize:25,
    });

    // ค้นหาทุกคอลัมน์
    const searchInput = document.getElementById("search");
    searchInput.addEventListener("input", () => {
      const val = searchInput.value.toLowerCase();
      table.setFilter(row => Object.values(row).some(v => String(v).toLowerCase().includes(val)));
    });

    // ปุ่มต่าง ๆ
    document.getElementById("btnCsv").onclick  = () => table.download("csv",  "data.csv");
    document.getElementById("btnXlsx").onclick = () => table.download("xlsx", "data.xlsx", {sheetName:"Data"});
    document.getElementById("btnPrint").onclick= () => table.print(false);
    document.getElementById("btnReset").onclick= () => { table.clearFilter(); searchInput.value=""; };

    // ====== โหลดข้อมูลจาก API (ถ้าต้องการ) ======
    // async function loadFromApi(){
    //   const res = await fetch("/api/orders");   // e.g., FastAPI ส่ง JSON array
    //   const data = await res.json();
    //   table.replaceData(data);
    // }
    // loadFromApi();

    // ====== บันทึกเมื่อแก้ไขเซลล์ (ตัวอย่าง) ======
    // table.on("cellEdited", async (cell) => {
    //   const row = cell.getRow().getData();
    //   await fetch(`/api/orders/${row.id}`, {
    //     method: "PUT",
    //     headers: {"Content-Type":"application/json"},
    //     body: JSON.stringify(row),
    //   });
    // });
  </script>
</body>
</html>
